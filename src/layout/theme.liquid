<!DOCTYPE html>
<html>
  <head>
    {% comment %} Base metadata {% endcomment %}
    {%- render 'page-base-meta',
        brand_color: branding_color,
        canonical_url: canonical_url,
        page_description: page_description,
        page_title: page_title,
        settings: settings,
        is_local_env: local_env?,
        shop: shop
    -%}

    {% comment %} Resource hints for performance {% endcomment %}
    {%- render 'page-resource-hints' -%}

    {% comment %} Preload fonts {% endcomment %}
    {%- render 'fonts', settings: settings -%}

    {% comment %} Load root variables {% endcomment %}
    {%- render 'css-root-variables', settings: settings -%}

    {% comment %} Async CSS loading with resource hints {% endcomment %}
    {%- render 'css-files-async-loader' -%}

    {% comment %} Dynamic loading CSS files {% endcomment %}
    {%- render 'css-files-loader', all_sections: sections.all -%}

    {{ sections_assets }}
    {{ content_for_header }}

    {%- render 'page-social-share-meta',
        canonical_url: canonical_url,
        locale: locale,
        image_url: page_meta_image_url,
        image_alt: page_meta_image_alt,
        page_description: page_description,
        page_title: page_title,
        product: product,
        shop: shop
    -%}

    {% comment %} Enhanced performance monitoring {% endcomment %}
    {%- render 'page-performance-monitoring' -%}

    {% comment %} Load Embla carousel library {% endcomment %}
    <script src="https://unpkg.com/embla-carousel@8.0.0/embla-carousel.umd.js" defer></script>
  </head>
  <body>
    <header class="header">
      {% section 'top-bar' %}
      {% section 'header' %}
    </header>

    <main id="main" role="main">
      {{ content_for_layout }}
    </main>

    {% section 'footer' %}

    {{ content_for_body }}

    {% comment %} Critical JavaScript files {% endcomment %}
    <script type="importmap">
      {
        "imports": {
          "utils.js": "{{ 'utils.js' | asset_url }}"
        }
      }
    </script>

    {%- assign section_names = 'header, top-bar, products, images, testimonials' | split: ', ' -%}
    {%- assign show_carousel_script = false -%}
    {%- assign show_focal_image_script = false -%}
    {%- assign show_search_script = false -%}
    {%- assign show_top_bar_script = false -%}

    {%- for section in sections.all -%}
      {%- assign section_type = section.type -%}
      {%- assign execute = false -%}

      {%- for name in section_names -%}
        {%- if section_type == name -%}
          {%- assign execute = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}

      {%- unless execute -%}
        {%- continue -%}
      {%- endunless -%}

      {%- if section_type == 'header' -%}
        {%- for block in section.blocks -%}
          {%- assign type = block.type -%}

          {%- unless type == 'search' -%}
            {%- continue -%}
          {%- endunless -%}

          {%- assign show_search_script = true -%}
        {%- endfor -%}
      {%- endif -%}

      {%- if section_type == 'top-bar' -%}
        {%- assign show_top_bar = section.settings.show_bar -%}

        {%- if show_top_bar -%}
          {%- assign show_top_bar_script = true -%}
        {%- endif -%}
      {%- endif -%}

      {%- if section_type == 'products' -%}
        {%- for block in section.blocks -%}
          {%- assign type = block.type -%}

          {%- unless type == 'product' -%}
            {%- continue -%}
          {%- endunless -%}

          {%- assign show_focal_image_script = true -%}
        {%- endfor -%}
      {%- endif -%}

      {%- if section_type == 'images' -%}
        {%- for block in section.blocks -%}
          {%- assign type = block.type -%}

          {%- unless type == 'image' -%}
            {%- continue -%}
          {%- endunless -%}

          {%- assign show_carousel_script = true -%}
        {%- endfor -%}
      {%- endif -%}

      {%- if section_type == 'testimonials' -%}
        {%- for block in section.blocks -%}
          {%- assign type = block.type -%}

          {%- unless type == 'testimonial' -%}
            {%- continue -%}
          {%- endunless -%}

          {%- assign show_carousel_script = true -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endfor -%}

    {% comment %} Non-critical JavaScript {% endcomment %}
    <script type="module" src="{{ 'main.js' | asset_url }}"></script>
    <script type="module" src="{{ 'header.js' | asset_url }}"></script>
    {%- if show_top_bar_script -%}
    <script type="module" src="{{ 'top-bar.js' | asset_url }}"></script>
    {%- endif -%}
    <script type="module" src="{{ 'image-loading.js' | asset_url }}"></script>
    {%- if show_search_script -%}
    <script type="module" src="{{ 'search.js' | asset_url }}"></script>
    {%- endif -%}
    {%- if show_carousel_script -%}
    <script type="module" src="{{ 'carousel.js' | asset_url }}"></script>
    {%- endif -%}
    {%- if show_focal_image_script -%}
    <script type="module" src="{{ 'focal-image.js' | asset_url }}"></script>
    {%- endif -%}
  </body>
</html>
